{% extends "base.html" %}
{% load static %}

{% block content %}

<style>
	/* Updated styles for better layout */
	.wrapper {
		display: flex;
		flex-direction: column;
		height: calc(100vh - 56px); /* Account for navbar */
		overflow: hidden;
	}

	.main-content {
		display: flex;
		flex: 1;
		overflow: hidden;
	}

	.control-sidebar {
		width: 300px;
		padding: 15px;
		background-color: #f8f9fa;
		border-left: 1px solid #e9ecef;
		overflow-y: auto;
		display: flex;
		flex-direction: column;
	}

	#canvasContainer {
		flex: 1;
		display: flex;
		align-items: center;
		justify-content: center;
		background-color: #e9ecef;
		position: relative;
		overflow: hidden;
	}

	#canvasDiv {
		position: relative;
		box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
	}

	#canvas {
		display: block;
	}

	.footer-bar {
		padding: 10px 15px;
		background-color: #f8f9fa;
		border-top: 1px solid #e9ecef;
		display: flex;
		justify-content: space-between;
		align-items: center;
		height: 60px;
	}

	.tool-buttons {
		display: flex;
		flex-wrap: wrap;
		gap: 8px;
		margin-bottom: 15px;
	}

	.tool-buttons button {
		flex: 1 0 auto;
		min-width: 95px;
	}

	#categories_coll {
		list-style: none;
		padding: 0;
		margin: 0 0 15px 0;
		overflow-y: auto;
	}

	#categories_coll li {
		padding: 8px 10px;
		margin-bottom: 5px;
		background-color: #fff;
		border-radius: 4px;
		border: 1px solid #ddd;
		display: flex;
		align-items: center;
	}

	#categories_coll .circle {
		width: 15px;
		height: 15px;
		border-radius: 50%;
		margin-left: auto;
	}

	.coordinate-display {
		font-size: 12px;
		color: #555;
	}

	.nav-buttons {
		display: flex;
		gap: 10px;
	}

	/* Measurement tools */
	.measurement-info {
		position: absolute;
		z-index: 100;
		background: rgba(255, 255, 255, 0.8);
		border: 1px solid #ddd;
		padding: 5px 10px;
		border-radius: 4px;
		font-size: 12px;
		display: none;
	}

	/* Add CSS for loading indicator */
	.overlay {
		position: absolute;
		top: 0;
		left: 0;
		width: 100%;
		height: 100%;
		display: flex;
		justify-content: center;
		align-items: center;
		background-color: rgba(0, 0, 0, 0.5);
		z-index: 9999;
	}
	
	.loading-spinner {
		width: 50px;
		height: 50px;
		border: 5px solid rgba(255, 255, 255, 0.3);
		border-radius: 50%;
		border-top-color: #fff;
		animation: spin 1s ease-in-out infinite;
	}
	
	@keyframes spin {
		to { transform: rotate(360deg); }
	}
	
	.toast-container {
		position: fixed;
		top: 20px;
		right: 20px;
		z-index: 10000;
	}
	
	.toast {
		background-color: #f8d7da;
		color: #721c24;
		padding: 15px 25px;
		border-radius: 4px;
		margin-bottom: 10px;
		box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
		display: flex;
		justify-content: space-between;
		max-width: 350px;
	}
	
	.toast-close {
		background: none;
		border: none;
		color: #721c24;
		font-size: 20px;
		cursor: pointer;
	}

	/* Loader overlay and spinner CSS */
	#loading-overlay {
		position: fixed;
		top: 0;
		left: 0;
		width: 100%;
		height: 100%;
		background-color: rgba(0, 0, 0, 0.5);
		display: flex;
		justify-content: center;
		align-items: center;
		z-index: 9999;
	}

	#canvasDiv.loading {
		position: relative;
	}

	.loading-spinner {
		position: absolute;
		top: 50%;
		left: 50%;
		transform: translate(-50%, -50%);
		z-index: 1000;
	}

	@keyframes spin {
		0% { transform: rotate(0deg); }
		100% { transform: rotate(360deg); }
	}

	.spinner-border {
		display: inline-block;
		width: 3rem;
		height: 3rem;
		vertical-align: text-bottom;
		border: 0.25em solid rgba(255, 255, 255, 0.5);
		border-right-color: #fff;
		border-radius: 50%;
		animation: spin .75s linear infinite;
	}

	.sr-only {
		position: absolute;
		width: 1px;
		height: 1px;
		padding: 0;
		margin: -1px;
		overflow: hidden;
		clip: rect(0, 0, 0, 0);
		white-space: nowrap;
		border: 0;
	}

	/* Notification styling */
	#notification-container {
		position: fixed;
		top: 20px;
		right: 20px;
		z-index: 9999;
		max-width: 350px;
	}

	.notification {
		padding: 15px;
		margin-bottom: 10px;
		border-radius: 4px;
		box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
		animation: slide-in 0.5s ease-out;
		color: white;
	}

	.notification.error {
		background-color: #dc3545;
	}

	.notification.success {
		background-color: #28a745;
	}

	.notification.warning {
		background-color: #ffc107;
		color: #212529;
	}

	.notification .close-btn {
		float: right;
		font-weight: bold;
		font-size: 20px;
		line-height: 20px;
		cursor: pointer;
		transition: 0.3s;
	}

	.notification .close-btn:hover {
		color: black;
	}

	@keyframes slide-in {
		from { transform: translateX(100%); opacity: 0; }
		to { transform: translateX(0); opacity: 1; }
	}

	@keyframes fade-out {
		from { opacity: 1; }
		to { opacity: 0; }
	}
</style>

<div class="wrapper">
	<div class="main-content">
		<!-- Canvas Container -->
		<div id="canvasContainer">
			<div id="canvasDiv">
				<canvas id="canvas" resize></canvas>
				<div id="measurementInfo" class="measurement-info"></div>
			</div>
		</div>

		<!-- Right Sidebar -->
		<div class="control-sidebar">
			<h5>Image Information</h5>
			<div class="card mb-3">
				<div class="card-body p-2">
					<p id="image_info_name" class="mb-1 small">Image: </p>
					<p id="image_info_dimensions" class="mb-1 small">Dimensions: </p>
					<p id="imageMetadata" class="mb-0 small">No image loaded</p>
				</div>
			</div>

			<h5>Tools</h5>
			<div class="tool-buttons">
				<button class="btn btn-sm btn-outline-primary" id="pen_button">Pen</button>
				<button class="btn btn-sm btn-outline-primary" id="polygon_button">Polygon</button>
				<button class="btn btn-sm btn-outline-primary" id="rectangle_button">Rectangle</button>
				<button class="btn btn-sm btn-outline-primary" id="circle_button">Circle</button>
				<button class="btn btn-sm btn-outline-primary" id="measure_button">Measure</button>
				<button class="btn btn-sm btn-outline-danger" id="remove_button">Remove</button>
				<button class="btn btn-sm btn-outline-secondary" id="undo_button">Undo</button>
			</div>

			<h5>Categories</h5>
			<ul id="categories_coll"></ul>

			<h5>Actions</h5>
			<div class="tool-buttons mb-3">
				<button class="btn btn-sm btn-success" id="save_button">Save</button>
				<button class="btn btn-sm btn-primary" id="screenshot_button">Screenshot</button>
				<button class="btn btn-sm btn-danger" id="clear_button">Clear</button>
			</div>

			<div class="mt-auto">
				<button class="btn btn-sm btn-outline-info w-100 mb-2" id="view_shp_button">View Dataset</button>
				<button class="btn btn-sm btn-outline-info w-100 mb-2" id="view_images_button" data-bs-toggle="modal" data-bs-target="#imagesModal">View All Images</button>
				<button class="btn btn-sm btn-outline-info w-100" data-bs-toggle="modal" data-bs-target="#exampleModalCenter">Bug report</button>
			</div>
		</div>
	</div>

	<!-- Footer -->
	<div class="footer-bar">
		<div class="coordinate-display">
			<span id="gps-coords">GPS: </span> | 
			<span id="pixel-coords">Pixels: </span> | 
			<span id="measure-distance">Distance: </span>
		</div>
		<div class="nav-buttons">
			<button class="btn btn-sm btn-outline-secondary" id="prev_button">Previous</button>
			<button class="btn btn-sm btn-primary" id="next_button">Next</button>
		</div>
	</div>
</div>

<!-- Modal -->
<div class="modal fade" id="exampleModalCenter" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
	<div class="modal-dialog modal-dialog-centered" role="document">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title" id="exampleModalCenterTitle">Bug report</h5>
				<button type="button" class="close" data-bs-dismiss="modal" aria-label="Close">
					<span aria-hidden="true">&times;</span>
				</button>
			</div>
			<div class="modal-body">
				<div id="bugreport_body">
					<div class="form-group">
						<label for="bugreport_title">Subject</label>
						<input type="text" class="form-control" name="bugreport_title" id="bugreport_title" placeholder="Enter the subject of the bug report">
					</div>
					<div class="form-group">
						<label for="bugreport_description">Description</label>
						<textarea class="form-control" name="bugreport_description" id="bugreport_description" rows="3" placeholder="Describe the bug and what you were doing when it happened"></textarea>
					</div>
				</div>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
				<button type="button" id="bugreport_send" class="btn btn-primary">Submit report</button>
			</div>
		</div>
	</div>
</div>

<!-- Add full image URL display at the bottom -->
<div style="position: fixed; bottom: 0; left: 0; width: 100%; background: rgba(0,0,0,0.7); color: white; padding: 5px 10px; font-size: 12px; z-index: 1000;">
    <span id="full-image-url">Image URL: </span>
</div>

<!-- Images List Modal -->
<div class="modal fade" id="imagesModal" tabindex="-1" role="dialog" aria-labelledby="imagesModalTitle" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="imagesModalTitle">All Available Images</h5>
                <button type="button" class="close" data-bs-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="text-center mb-3" id="loading-images">
                    <div class="spinner-border text-primary" role="status">
                        <span class="sr-only">Loading...</span>
                    </div>
                    <p>Loading images from database...</p>
                </div>
                <div id="images-list-container">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>Preview</th>
                                <th>Image Name</th>
                                <th>Dimensions</th>
                                <th>Full URL</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="images-list-body">
                            <!-- Images will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="refresh-images-list">Refresh List</button>
            </div>
        </div>
    </div>
</div>

<!-- JavaScript for the app -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>
<script src="https://deepgis.org/static/scripts/paperjs/dist/paper-full.min.js"></script>
<script type="text/javascript">
	// Setup PaperJS
	paper.install(window);
	
	var globals = {
		tool: null,
		path: null,
		raster: null,
		groups: [],
		undos: [],
		initialCenter: null,
		currentTool: null,
		measurementPath: null,
		measurementText: null,
		isMeasuring: false,
		measureStartPoint: null
	};

	// Variable declarations
	let currentImage = null;
	let currentCategory = null;
	let currentColor = "#ff0000";
	let isDrawing = false;
	let currentPath = [];
	let allPaths = [];
	let currentTool = null;
	let imageCache = {};

	// ... existing code ...

	// Add measurement tool functionality
	function initializeMeasurementTool() {
		const measureTool = new paper.Tool();
		
		measureTool.onMouseDown = function(event) {
			if (!globals.isMeasuring) {
				// Start measuring
				globals.isMeasuring = true;
				globals.measureStartPoint = event.point;
				
				// Create measurement line
				globals.measurementPath = new paper.Path.Line(event.point, event.point);
				globals.measurementPath.strokeColor = 'red';
				globals.measurementPath.strokeWidth = 2;
				globals.measurementPath.dashArray = [5, 5];
				
				// Show measurement info
				$('#measurementInfo').show().css({
					left: event.point.x + 10,
					top: event.point.y + 10
				});
			} else {
				// Finish measuring
				globals.isMeasuring = false;
				
				// Clean up
				if (globals.measurementPath) {
					globals.measurementPath.remove();
					globals.measurementPath = null;
				}
				
				$('#measurementInfo').hide();
				$('#measure-distance').text('Distance: 0px');
			}
		};
		
		measureTool.onMouseMove = function(event) {
			// Update pixel coordinates display
			const x = Math.round(event.point.x);
			const y = Math.round(event.point.y);
			$('#pixel-coords').text(`Pixels: ${x},${y}`);
			
			// Update measurement if measuring
			if (globals.isMeasuring && globals.measureStartPoint) {
				// Update line
				globals.measurementPath.segments[1].point = event.point;
				
				// Calculate distance
				const dx = event.point.x - globals.measureStartPoint.x;
				const dy = event.point.y - globals.measureStartPoint.y;
				const distance = Math.sqrt(dx * dx + dy * dy);
				const rounded = Math.round(distance * 100) / 100;
				
				// Update displays
				$('#measure-distance').text(`Distance: ${rounded}px`);
				$('#measurementInfo').text(`Start: ${Math.round(globals.measureStartPoint.x)},${Math.round(globals.measureStartPoint.y)} | End: ${x},${y} | Distance: ${rounded}px`);
				
				// Position the info box
				$('#measurementInfo').css({
					left: event.point.x + 10,
					top: event.point.y + 10
				});
			}
		};
		
		return measureTool;
	}

	// ... existing code ...

	// Add event listeners for UI
	$(document).ready(function() {
		// Initialize PaperJS
		paper.setup('canvas');
		
		// Global variable to track image load status
		let imageLoadAttempted = false;

		// Initialize tools
		const penTool = new paper.Tool();
		penTool.onMouseDown = function(event) {
			globals.path = new paper.Path();
			globals.path.strokeColor = 'black';
			globals.path.strokeWidth = 2;
			globals.path.add(event.point);
		};
		penTool.onMouseDrag = function(event) {
			globals.path.add(event.point);
		};
		
		const polygonTool = new paper.Tool();
		polygonTool.onMouseDown = function(event) {
			if (!globals.path) {
				globals.path = new paper.Path();
				globals.path.strokeColor = 'black';
				globals.path.strokeWidth = 2;
				globals.path.add(event.point);
			} else {
				globals.path.add(event.point);
			}
		};
		polygonTool.onKeyDown = function(event) {
			if (event.key === 'escape' && globals.path) {
				globals.path.closed = true;
				globals.path.fillColor = 'rgba(255, 255, 255, 0.5)';
				globals.path = null;
			}
		};
		
		const rectangleTool = new paper.Tool();
		rectangleTool.onMouseDown = function(event) {
			globals.path = new paper.Path.Rectangle({
				from: event.point,
				to: event.point,
				strokeColor: 'black',
				strokeWidth: 2
			});
		};
		rectangleTool.onMouseDrag = function(event) {
			globals.path.remove();
			globals.path = new paper.Path.Rectangle({
				from: globals.path.firstSegment.point,
				to: event.point,
				strokeColor: 'black',
				strokeWidth: 2
			});
		};
		
		const circleTool = new paper.Tool();
		circleTool.onMouseDown = function(event) {
			globals.path = new paper.Path.Circle({
				center: event.point,
				radius: 1,
				strokeColor: 'black',
				strokeWidth: 2
			});
		};
		circleTool.onMouseDrag = function(event) {
			const radius = event.point.getDistance(globals.path.position);
			globals.path.remove();
			globals.path = new paper.Path.Circle({
				center: globals.path.position,
				radius: radius,
				strokeColor: 'black',
				strokeWidth: 2
			});
		};
		
		const measureTool = initializeMeasurementTool();
		
		const removeTool = new paper.Tool();
		removeTool.onMouseDown = function(event) {
			const hitResult = paper.project.hitTest(event.point);
			if (hitResult && hitResult.item) {
				hitResult.item.remove();
			}
		};
		
		// Tool button listeners
		$('#pen_button').click(function() {
			penTool.activate();
			updateActiveToolButton(this);
			globals.currentTool = 'pen';
		});
		
		$('#polygon_button').click(function() {
			polygonTool.activate();
			updateActiveToolButton(this);
			globals.currentTool = 'polygon';
		});
		
		$('#rectangle_button').click(function() {
			rectangleTool.activate();
			updateActiveToolButton(this);
			globals.currentTool = 'rectangle';
		});
		
		$('#circle_button').click(function() {
			circleTool.activate();
			updateActiveToolButton(this);
			globals.currentTool = 'circle';
		});
		
		$('#measure_button').click(function() {
			measureTool.activate();
			updateActiveToolButton(this);
			globals.currentTool = 'measure';
		});
		
		$('#remove_button').click(function() {
			removeTool.activate();
			updateActiveToolButton(this);
			globals.currentTool = 'remove';
		});
		
		// Navigation buttons
		$('#prev_button').click(function() {
			loadImage('prev');
		});
		
		$('#next_button').click(function() {
			loadImage('next');
		});
		
		// Helper function to update active button
		function updateActiveToolButton(button) {
			$('.tool-buttons button').removeClass('active');
			$(button).addClass('active');
		}
		
		// Function to show loading overlay
		function showLoadingOverlay() {
			// Create loading overlay if it doesn't exist
			if ($('#loading-overlay').length === 0) {
				$('body').append(`
					<div id="loading-overlay">
						<div class="spinner"></div>
						<div class="loading-text">Loading image...</div>
					</div>
				`);
			} else {
				$('#loading-overlay').show();
			}
		}
		
		// Function to hide loading overlay
		function hideLoadingOverlay() {
			$('#loading-overlay').hide();
		}
		
		// Function to clear the canvas
		function clearCanvas() {
			const canvas = document.getElementById('canvas');
			if (canvas) {
				const ctx = canvas.getContext('2d');
				ctx.clearRect(0, 0, canvas.width, canvas.height);
			}
			
			// Clear any active drawing states
			isDrawing = false;
			currentPath = [];
			allPaths = [];
			
			// Reset any active tools
			currentTool = null;
			$(".tool-button").removeClass("active");
		}
		
		// Function to load image from server
		function loadImage(direction) {
			showLoadingOverlay("Loading image...");
			
			$.ajax({
				url: "{% url 'get_new_image' %}",
				type: "GET",
				data: { direction: direction },
				success: function(data) {
					if (data.success) {
						displayImage(
							data.image_name,
							data.image_path,
							data.categories,
							data.shapes,
							data.colors,
							{ x: 0, y: 0 },
							data.width,
							data.height,
							0
						);
						
						// Update navigation button states
						updateNavigationButtons(data.navigation);
						
						// Update the full image URL display
						$("#full-image-url").text("Image URL: " + data.image_path);
						
						hideLoadingOverlay();
						showSuccessMessage("Image loaded successfully");
					} else {
						hideLoadingOverlay();
						// Show error message without falling back to sample images
						showErrorMessage(data.message || "No images available from server. Please add images to the database.");
						
						// Draw error message on canvas
						const canvas = document.getElementById('canvas');
						if (canvas) {
							const ctx = canvas.getContext('2d');
							canvas.width = 800;  // Default size
							canvas.height = 600;
							ctx.fillStyle = "#f8d7da";
							ctx.fillRect(0, 0, canvas.width, canvas.height);
							ctx.font = "16px Arial";
							ctx.fillStyle = "#721c24";
							ctx.textAlign = "center";
							ctx.fillText("No Images Available", canvas.width/2, canvas.height/2 - 20);
							ctx.font = "14px Arial";
							ctx.fillText("Please add images to the database", canvas.width/2, canvas.height/2 + 20);
						}
					}
				},
				error: function(xhr, status, error) {
					console.error("Error loading image:", error);
					hideLoadingOverlay();
					showErrorMessage("Server error: " + error);
					
					// Draw error message on canvas
					const canvas = document.getElementById('canvas');
					if (canvas) {
						const ctx = canvas.getContext('2d');
						canvas.width = 800;  // Default size
						canvas.height = 600;
						ctx.fillStyle = "#f8d7da";
						ctx.fillRect(0, 0, canvas.width, canvas.height);
						ctx.font = "16px Arial";
						ctx.fillStyle = "#721c24";
						ctx.textAlign = "center";
						ctx.fillText("Server Error", canvas.width/2, canvas.height/2 - 20);
						ctx.font = "14px Arial";
						ctx.fillText("Could not connect to server: " + error, canvas.width/2, canvas.height/2 + 20);
					}
				}
			});
		}
		
		// Function to update navigation button states
		function updateNavigationButtons(navigation) {
			if (navigation) {
				$("#prev_button").prop("disabled", !navigation.has_prev);
				$("#next_button").prop("disabled", !navigation.has_next);
				
				// Update image count if available
				if (navigation.current_index && navigation.total_images) {
					$("#imageMetadata").text(`Image ${navigation.current_index} of ${navigation.total_images}`);
				}
			}
		}
		
		// Function to display image
		function displayImage(imageName, imagePath, categories, shapes, colors, coordinates, width, height, rotation) {
			// Clear the canvas and existing shapes
			clearCanvas();
			
			// Update the image information in the UI
			$("#image_info_name").text("Image: " + imageName);
			$("#image_info_dimensions").text("Dimensions: " + width + "x" + height);
			
			// Update the full image URL display
			$("#full-image-url").text("Image URL: " + imagePath);
			
			// Store the current image data
			currentImage = {
				name: imageName,
				path: imagePath,
				categories: categories,
				shapes: shapes,
				colors: colors,
				coordinates: coordinates,
				width: width,
				height: height,
				rotation: rotation
			};
			
			// Update categories dropdown
			updateCategoriesDropdown(categories, colors);
			
			// Draw the image on the canvas
			drawImageOnCanvas(imagePath, width, height, rotation);
		}
		
		// Function to update the categories dropdown
		function updateCategoriesDropdown(categories, colors) {
			// Clear the existing categories
			const categoriesList = $("#categories_coll");
			categoriesList.empty();
			
			// Add categories to the list
			for (let i = 0; i < categories.length; i++) {
				const categoryName = categories[i];
				const categoryColor = colors[i];
				
				// Create list item
				const listItem = $("<li></li>")
					.attr("data-category", categoryName)
					.attr("data-color", categoryColor)
					.html(`
						<span class="category-name">${categoryName}</span>
						<div class="circle" style="background-color: ${categoryColor}"></div>
					`);
				
				// Add click handler to select this category
				listItem.on("click", function() {
					// Remove active class from all items
					categoriesList.find("li").removeClass("active");
					// Add active class to this item
					$(this).addClass("active");
					// Set current category and color
					currentCategory = categoryName;
					currentColor = categoryColor;
				});
				
				// Add to the list
				categoriesList.append(listItem);
			}
			
			// Set the first category as selected
			if (categories.length > 0) {
				categoriesList.find("li:first").addClass("active");
				currentCategory = categories[0];
				currentColor = colors[0];
			}
		}
		
		// Function to draw the image on canvas
		function drawImageOnCanvas(imagePath, width, height, rotation) {
			const canvas = document.getElementById('canvas');
			const ctx = canvas.getContext('2d');
			
			// Check if image path seems valid before trying to load
			if (!imagePath || typeof imagePath !== 'string' || imagePath.trim() === '' || imagePath.endsWith('/')) {
				console.error("Invalid image path:", imagePath);
				showErrorMessage("Invalid image path. The URL appears to be a directory or is empty.");
				
				// Draw error message on canvas
				canvas.width = width || 800;
				canvas.height = height || 600;
				ctx.fillStyle = "#f8d7da";
				ctx.fillRect(0, 0, canvas.width, canvas.height);
				ctx.font = "16px Arial";
				ctx.fillStyle = "#721c24";
				ctx.textAlign = "center";
				ctx.fillText("Invalid Image Path", canvas.width/2, canvas.height/2 - 20);
				ctx.font = "12px Arial"; 
				ctx.fillText(imagePath || "No path provided", canvas.width/2, canvas.height/2 + 20);
				
				hideLoadingOverlay();
				return;
			}
			
			// Set canvas dimensions
			canvas.width = width;
			canvas.height = height;
			
			// Create a new image
			const img = new Image();
			
			// Set a 15-second timeout to catch hanging loads
			const loadTimeout = setTimeout(() => {
				if (!img.complete) {
					console.error("Image load timed out:", imagePath);
					hideLoadingOverlay();
					showErrorMessage(`Image load timed out. Check console for details.`);
				}
			}, 15000);
			
			img.onload = function() {
				// Clear the timeout as the image loaded successfully
				clearTimeout(loadTimeout);
				
				// Clear the canvas
				ctx.clearRect(0, 0, canvas.width, canvas.height);
				
				// Save the current context state
				ctx.save();
				
				// Move to the center of the canvas
				ctx.translate(canvas.width / 2, canvas.height / 2);
				
				// Rotate if needed
				if (rotation !== 0) {
					ctx.rotate(rotation * Math.PI / 180);
				}
				
				// Draw the image centered
				ctx.drawImage(img, -canvas.width / 2, -canvas.height / 2, canvas.width, canvas.height);
				
				// Restore the context
				ctx.restore();
				
				// Hide loading overlay once image is loaded
				hideLoadingOverlay();
				console.log("Image loaded successfully:", imagePath);
			};
			
			img.onerror = function(e) {
				// Clear the timeout as the image failed to load
				clearTimeout(loadTimeout);
				
				console.error("Failed to load image:", imagePath, e);
				hideLoadingOverlay();
				
				// Try to provide a more detailed error message
				let errorDetail = "";
				if (imagePath.indexOf('://') === -1) {
					errorDetail = " URL may be missing protocol (http:// or https://).";
				} else if (imagePath.endsWith('/')) {
					errorDetail = " URL appears to be a directory, not a file.";
				} else if (!imagePath.match(/\.(jpg|jpeg|png|gif|bmp|webp|tiff)$/i)) {
					errorDetail = " URL might not point to an image file.";
				} else {
					errorDetail = " The server may be unreachable or the file may not exist.";
				}
				
				showErrorMessage(`Failed to load image.${errorDetail} Path: ${imagePath}`);
				
				// Draw error message on canvas
				ctx.fillStyle = "#f8d7da";
				ctx.fillRect(0, 0, canvas.width, canvas.height);
				ctx.font = "16px Arial";
				ctx.fillStyle = "#721c24";
				ctx.textAlign = "center";
				ctx.fillText("Image Failed to Load", canvas.width/2, canvas.height/2 - 20);
				ctx.font = "12px Arial";
				ctx.fillText(imagePath, canvas.width/2, canvas.height/2 + 20);
				ctx.font = "12px Arial";
				ctx.fillText(errorDetail, canvas.width/2, canvas.height/2 + 40);
			};
			
			// Set crossOrigin to anonymous to prevent CORS issues with external image sources
			img.crossOrigin = "anonymous";
			
			// Log the attempt to load the image
			console.log("Attempting to load image:", imagePath);
			
			// Set the image source last, as this triggers the loading
			img.src = imagePath;
		}
		
		// Start initial image loading
		console.log("Initiating first image load from database...");
		loadImage('next');
	});

	// Function to show error, success, or warning messages to user
	function showNotification(message, type = 'error', duration = 5000) {
		// Create notification container if it doesn't exist
		if ($('#notification-container').length === 0) {
			$('body').append('<div id="notification-container"></div>');
		}
		
		// Generate a unique ID for this notification
		const notificationId = 'notification-' + Date.now();
		
		// Create notification element
		const notification = $(`
			<div id="${notificationId}" class="notification ${type}">
				<span class="close-btn">&times;</span>
				${message}
			</div>
		`);
		
		// Add to container
		$('#notification-container').append(notification);
		
		// Add click handler to close button
		$(`#${notificationId} .close-btn`).on('click', function() {
			$(`#${notificationId}`).css('animation', 'fade-out 0.5s').on('animationend', function() {
				$(this).remove();
			});
		});
		
		// Auto-remove after duration
		setTimeout(() => {
			if ($(`#${notificationId}`).length) {
				$(`#${notificationId}`).css('animation', 'fade-out 0.5s').on('animationend', function() {
					$(this).remove();
				});
			}
		}, duration);
	}

	// Convenience functions for different notification types
	function showErrorMessage(message, duration = 5000) {
		showNotification(message, 'error', duration);
	}

	function showSuccessMessage(message, duration = 5000) {
		showNotification(message, 'success', duration);  
	}

	function showWarningMessage(message, duration = 5000) {
		showNotification(message, 'warning', duration);
	}
</script>
{% endblock %}
