<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DeepGIS Map</title>
    
    <!-- Core Dependencies -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw-src.css" crossorigin="anonymous"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet-measure@3.1.0/dist/leaflet-measure.css" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
    
    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }

        #map {
            position: absolute;
            top: 0;
            right: 300px;
            bottom: 0;
            left: 0;
            width: auto;
            height: 100%;
            z-index: 1;
        }

        #sidebar-wrapper {
            width: 300px;
            position: fixed;
            height: 100%;
            z-index: 1000;
            top: 0;
            right: 0;
            background: white;
            box-shadow: -2px 0 5px rgba(0,0,0,0.1);
            overflow-y: auto;
            transform: translateX(0);
        }

        #wrapper.show-sidebar #sidebar-wrapper {
            transform: translateX(0);
        }

        .mobile-toggle {
            position: fixed;
            top: 10px;
            right: 310px;
            z-index: 2000;
            background: white;
            border: none;
            border-radius: 4px;
            padding: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            display: none;
        }

        .layer-item {
            display: flex;
            align-items: center;
            padding: 8px;
            border-bottom: 1px solid #eee;
        }

        .layer-item:hover {
            background: #f8f9fa;
        }

        .layer-controls {
            padding: 15px;
            border-bottom: 1px solid #dee2e6;
        }

        .layer-group {
            margin-bottom: 15px;
        }

        .layer-group-title {
            font-weight: bold;
            margin-bottom: 8px;
        }

        /* Vector tile specific styles */
        .vector-layer-legend {
            padding: 10px;
            background: #fff;
            border-radius: 4px;
            margin: 5px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }

        .vector-style-control {
            margin-top: 10px;
        }

        /* Error handling styles */
        .tile-error {
            background: rgba(255, 0, 0, 0.1);
            border: 1px solid red;
        }

        @media (max-width: 768px) {
            .mobile-toggle {
                display: block;
                right: 10px;
            }

            #sidebar-wrapper {
                transform: translateX(100%);
                width: 80%;
                max-width: 300px;
            }

            #map {
                right: 0;
            }

            #wrapper.show-sidebar #sidebar-wrapper {
                transform: translateX(0);
            }
        }

        #histogram {
            width: 100%;
            height: 200px;
            max-width: 800px;
            max-height: 400px;
        }

        .chart-container {
            position: relative;
            height: 200px;
            width: 100%;
        }
    </style>
</head>

<body>
    <button class="mobile-toggle" id="sidebarToggle">
        <i class="fa fa-bars"></i>
    </button>

    <div id="wrapper">
        <div id="sidebar-wrapper">
            <div class="sidebar-content">
                <div class="sidebar-header p-3 bg-light">
                    <h5 class="m-0"><i class="fas fa-globe"></i> DeepGIS</h5>
                </div>
                
                <div class="layer-controls">
                    <div class="layer-group">
                        <div class="layer-group-title">
                            <i class="fa fa-calendar"></i> Available Dates
                        </div>
                        <div class="form-group mb-3">
                            <select class="form-select" id="dateSelect">
                                <!-- Will be populated dynamically -->
                            </select>
                        </div>
                    </div>

                    <div class="layer-group">
                        <div class="layer-group-title">
                            <i class="fa fa-layer-group"></i> Layer Types
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" id="rasterLayerToggle" checked>
                            <label class="form-check-label" for="rasterLayerToggle">Raster Layer</label>
                        </div>
                        <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="vectorLayerToggle" checked>
                            <label class="form-check-label" for="vectorLayerToggle">Vector Layer</label>
                        </div>
                    </div>

                    <div class="layer-group">
                        <div class="layer-group-title">
                            <i class="fa fa-map"></i> Base Map
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" id="baseMapToggle" checked>
                            <label class="form-check-label" for="baseMapToggle">Show Base Map</label>
                        </div>
                    </div>
                </div>

                <div class="layer-controls">
                    <h6><i class="fa fa-chart-bar"></i> Statistics</h6>
                    <div class="chart-container">
                        <canvas id="histogram"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="map"></div>
    
    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/leaflet-measure@3.1.0/dist/leaflet-measure.min.js" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/leaflet.vectorgrid@latest/dist/Leaflet.VectorGrid.bundled.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js" crossorigin="anonymous"></script>

    <script>
        // Helper function to show notifications
        function showSnackBar(message) {
            const snackbar = document.createElement('div');
            snackbar.style.cssText = `
                position: fixed;
                bottom: 20px;
                left: 50%;
                transform: translateX(-50%);
                background-color: #333;
                color: white;
                padding: 12px 24px;
                border-radius: 4px;
                z-index: 1000;
                min-width: 250px;
                text-align: center;
                box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            `;
            snackbar.textContent = message;
            document.body.appendChild(snackbar);
            setTimeout(() => snackbar.remove(), 3000);
        }

        // Wait for all scripts to load
        function waitForDependencies() {
            return new Promise((resolve, reject) => {
                const checkDependencies = () => {
                    if (typeof L !== 'undefined' && 
                        typeof L.map !== 'undefined' && 
                        typeof L.tileLayer !== 'undefined' &&
                        typeof L.vectorGrid !== 'undefined') {
                        resolve();
                    } else {
                        setTimeout(checkDependencies, 100);
                    }
                };
                // Set a timeout to avoid infinite waiting
                setTimeout(() => reject(new Error('Dependencies failed to load')), 10000);
                checkDependencies();
            });
        }

        // Initialize everything when the document is ready
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                // Disable touch events that are causing issues
                L.Browser.touch = false;

                // Initialize with sidebar shown
                document.getElementById('wrapper').classList.add('show-sidebar');

                // Wait for dependencies
                await waitForDependencies();

                // Initialize map
                const map = L.map('map', {
                    zoomControl: true,
                    attributionControl: true,
                    tap: false,
                    zoom: 22,
                    maxZoom: 22,
                    preferCanvas: true
                }).setView([33.4255, -111.9400], 15);

                // Test vector tile layer from OSM
                const testVectorLayer = L.vectorGrid.protobuf(
                    'https://tile.openstreetmap.org/vectiles/{z}/{x}/{y}.pbf', {
                    vectorTileLayerStyles: {
                        water: {
                            fill: true,
                            weight: 1,
                            fillColor: '#06B6D4',
                            color: '#0891B2',
                            fillOpacity: 0.2,
                            opacity: 0.4
                        },
                        landcover: {
                            fill: true,
                            weight: 1,
                            fillColor: '#4ADE80',
                            color: '#22C55E',
                            fillOpacity: 0.2,
                            opacity: 0.4
                        },
                        landuse: {
                            fill: true,
                            weight: 1,
                            fillColor: '#60A5FA',
                            color: '#3B82F6',
                            fillOpacity: 0.2,
                            opacity: 0.4
                        },
                        building: {
                            fill: true,
                            weight: 1,
                            fillColor: '#475569',
                            color: '#64748B',
                            fillOpacity: 0.2,
                            opacity: 0.4
                        }
                    },
                    maxZoom: 22,
                    tolerance: 5,
                    attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap contributors</a>'
                }).addTo(map);

                console.log('Test vector layer added to map');

                // Global variables
                const MBTILES_SERVER = 'https://mbtiles.deepgis.org';

                // Drawing tools
                const drawnItems = new L.FeatureGroup().addTo(map);
                const drawControl = new L.Control.Draw({
                    edit: {
                        featureGroup: drawnItems
                    },
                    draw: {
                        polygon: {
                            allowIntersection: false,
                            showArea: true
                        },
                        rectangle: true,
                        circle: false,
                        circlemarker: false,
                        marker: true
                    }
                });
                map.addControl(drawControl);

                map.on(L.Draw.Event.CREATED, (e) => {
                    const layer = e.layer;
                    drawnItems.addLayer(layer);
                });

                // Initialize map and load layers
                async function initializeMap() {
                    try {
                        // Fetch available layers
                        const response = await fetch(`${MBTILES_SERVER}/data.json`);
                        if (!response.ok) throw new Error('Failed to fetch layers');
                        const data = await response.json();

                        // Log available layers
                        console.group('Available Layers');
                        console.log('Total layers:', Object.keys(data).length);

                        // Group layers by date
                        const layersByDate = {};
                        Object.entries(data).forEach(([id, info]) => {
                            if (!info || typeof info !== 'object') return;
                            
                            // Extract date from layer name (assuming format: BF_MM-DD-YYYY or bf_aug_2020)
                            let date = 'Unknown';
                            const dateMatch = info.name.match(/BF_(\d{2}-\d{2}-\d{4})/);
                            const altDateMatch = info.name.match(/bf_(\w+)_(\d{4})/);
                            
                            if (dateMatch) {
                                date = dateMatch[1];
                            } else if (altDateMatch) {
                                const month = altDateMatch[1];
                                const year = altDateMatch[2];
                                date = `${month}-${year}`;
                            }
                            
                            if (!layersByDate[date]) {
                                layersByDate[date] = {
                                    raster: null,
                                    vector: null
                                };
                            }

                            const layerInfo = {
                                id,
                                name: info.name,
                                format: info.format,
                                minzoom: info.minzoom,
                                maxzoom: info.maxzoom,
                                bounds: info.bounds,
                                center: info.center
                            };

                            if (info.format === 'pbf') {
                                layersByDate[date].vector = layerInfo;
                            } else {
                                layersByDate[date].raster = layerInfo;
                            }
                        });

                        // Populate date select
                        const dateSelect = document.getElementById('dateSelect');
                        const dates = Object.keys(layersByDate).sort((a, b) => {
                            if (a === 'Unknown') return 1;
                            if (b === 'Unknown') return -1;
                            return b.localeCompare(a); // Simple string comparison for mixed date formats
                        });

                        dates.forEach(date => {
                            const option = document.createElement('option');
                            option.value = date;
                            option.textContent = date;
                            dateSelect.appendChild(option);
                        });

                        // Initialize with OpenStreetMap
                        const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                            attribution: '© OpenStreetMap contributors'
                        }).addTo(map);

                        // Set up layer toggles
                        const rasterLayerToggle = document.getElementById('rasterLayerToggle');
                        const vectorLayerToggle = document.getElementById('vectorLayerToggle');
                        const baseMapToggle = document.getElementById('baseMapToggle');

                        let currentLayers = {
                            raster: null,
                            vector: null
                        };

                        // Function to load layers for selected date
                        async function loadLayersForDate(date) {
                            const layers = layersByDate[date];
                            if (!layers) return;

                            // Remove current layers
                            if (currentLayers.raster) {
                                map.removeLayer(currentLayers.raster);
                            }
                            if (currentLayers.vector) {
                                map.removeLayer(currentLayers.vector);
                            }

                            // Load raster layer
                            if (layers.raster) {
                                const layerPath = layers.raster.name.toLowerCase()
                                    .replace(/[_\s-]+/g, '_')
                                    .replace(/\.mbtiles$/, '');
                                
                                try {
                                    currentLayers.raster = L.tileLayer(`${MBTILES_SERVER}/data/${layerPath}/{z}/{x}/{y}.png`, {
                                        minZoom: layers.raster.minzoom || 0,
                                        maxZoom: layers.raster.maxzoom || 22,
                                        bounds: layers.raster.bounds ? L.latLngBounds([
                                            [layers.raster.bounds[1], layers.raster.bounds[0]],
                                            [layers.raster.bounds[3], layers.raster.bounds[2]]
                                        ]) : null
                                    });

                                    if (rasterLayerToggle.checked) {
                                        currentLayers.raster.addTo(map);
                                    }
                                } catch (error) {
                                    console.warn('Error loading raster layer:', error);
                                }
                            }

                            // Load vector layer
                            if (layers.vector) {
                                try {
                                    // Convert layer name to match the format bf_dec_2020_vector
                                    const dateMatch = layers.vector.name.match(/BF_(\d{2})-(\d{2})-(\d{4})/i);
                                    const altDateMatch = layers.vector.name.match(/bf_(\w+)_(\d{4})/i);
                                    
                                    let layerPath;
                                    if (dateMatch) {
                                        // Convert numeric month to text
                                        const monthNames = {
                                            '01': 'jan', '02': 'feb', '03': 'mar', '04': 'apr',
                                            '05': 'may', '06': 'jun', '07': 'jul', '08': 'aug',
                                            '09': 'sep', '10': 'oct', '11': 'nov', '12': 'dec'
                                        };
                                        const month = monthNames[dateMatch[1]] || 'dec';
                                        const year = dateMatch[3];
                                        layerPath = `bf_${month}_${year}_vector`;
                                    } else if (altDateMatch) {
                                        layerPath = layers.vector.name.toLowerCase();
                                    } else {
                                        layerPath = layers.vector.name.toLowerCase()
                                            .replace(/[_\s-]+/g, '_')
                                            .replace(/\.mbtiles$/, '')
                                            + '_vector';
                                    }

                                    // Construct URL using exact format
                                    const directTileUrl = `${MBTILES_SERVER}/data/${layerPath}/{z}/{x}/{y}.pbf`;

                                    console.log('Loading vector layer:', {
                                        originalName: layers.vector.name,
                                        layerPath,
                                        directTileUrl
                                    });

                                    // Create vector layer
                                    currentLayers.vector = L.vectorGrid.protobuf(directTileUrl, {
                                        minZoom: layers.vector.minzoom || 0,
                                        maxZoom: layers.vector.maxzoom || 22,
                                        bounds: layers.vector.bounds ? L.latLngBounds([
                                            [layers.vector.bounds[1], layers.vector.bounds[0]],
                                            [layers.vector.bounds[3], layers.vector.bounds[2]]
                                        ]) : null,
                                        vectorTileLayerStyles: {
                                            '*': {
                                                weight: 2,
                                                color: '#475569',
                                                fillColor: '#64748B',
                                                fillOpacity: 0.6
                                            }
                                        },
                                        interactive: true,
                                        rendererFactory: L.canvas.tile,
                                        maxNativeZoom: 22,
                                        tolerance: 5
                                    });

                                    // Add to map if toggle is checked
                                    if (vectorLayerToggle.checked && map) {
                                        map.addLayer(currentLayers.vector);
                                    }

                                    // Enable vector toggle since layer loaded successfully
                                    vectorLayerToggle.disabled = false;
                                    vectorLayerToggle.checked = true;

                                    console.log('Vector layer loaded successfully');
                                    
                                } catch (error) {
                                    console.warn('Error loading vector layer:', error);
                                    vectorLayerToggle.disabled = true;
                                    vectorLayerToggle.checked = false;
                                    showSnackBar('Error loading vector layer. Will retry on next selection.');
                                }
                            } else {
                                // Disable vector toggle if no vector layer available
                                vectorLayerToggle.disabled = true;
                                vectorLayerToggle.checked = false;
                            }

                            // Set map view if bounds available
                            const layerWithBounds = layers.raster || layers.vector;
                            if (layerWithBounds && layerWithBounds.bounds) {
                                map.fitBounds([
                                    [layerWithBounds.bounds[1], layerWithBounds.bounds[0]],
                                    [layerWithBounds.bounds[3], layerWithBounds.bounds[2]]
                                ]);
                            }
                        }

                        // Set up event listeners
                        dateSelect.addEventListener('change', (e) => {
                            // Reset vector layer toggle state
                            vectorLayerToggle.disabled = false;
                            vectorLayerToggle.checked = true;
                            loadLayersForDate(e.target.value);
                        });

                        rasterLayerToggle.addEventListener('change', (e) => {
                            if (currentLayers.raster) {
                                if (e.target.checked) {
                                    currentLayers.raster.addTo(map);
                                } else {
                                    map.removeLayer(currentLayers.raster);
                                }
                            }
                        });

                        vectorLayerToggle.addEventListener('change', (e) => {
                            if (currentLayers.vector) {
                                if (e.target.checked) {
                                    currentLayers.vector.addTo(map);
                                } else {
                                    map.removeLayer(currentLayers.vector);
                                }
                            }
                        });

                        baseMapToggle.addEventListener('change', (e) => {
                            if (e.target.checked) {
                                osm.addTo(map);
                            } else {
                                map.removeLayer(osm);
                            }
                        });

                        // Load initial layers
                        if (dates.length > 0) {
                            loadLayersForDate(dates[0]);
                        }

                    } catch (error) {
                        console.error('Error initializing map:', error);
                        showSnackBar('Error loading layers. Please try refreshing the page.');
                    }
                }

                // Initialize map
                initializeMap();

                // Initialize histogram
                const ctx = document.getElementById('histogram').getContext('2d');
                const chart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: [],
                        datasets: [{
                            label: 'Histogram',
                            data: [],
                            backgroundColor: 'rgba(75, 192, 192, 0.2)',
                            borderColor: 'rgba(75, 192, 192, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });

                new ResizeObserver(entries => {
                    for (let entry of entries) {
                        if (entry.target.id === 'histogram') {
                            chart.resize();
                        }
                    }
                }).observe(document.getElementById('histogram'));

            } catch (error) {
                console.error('Error initializing application:', error);
                showSnackBar('Error initializing application. Please refresh the page.');
            }
        });

        // Add resize handler to update map when sidebar toggles
        function updateMapSize() {
            map.invalidateSize();
        }

        // UI Controls with map resize
        document.getElementById('sidebarToggle').addEventListener('click', () => {
            const wrapper = document.getElementById('wrapper');
            wrapper.classList.toggle('show-sidebar');
            setTimeout(updateMapSize, 300); // Wait for transition to complete
        });
    </script>
</body>

</html>
